# 消费意愿数值化衡量系统协议规范
> **版本号：0.0.1**  
> **创建时间：2025-07-10**  
> **修改时间：2025-07-10**  
> **作者：林西 (Kino)**  
> **特别说明：统一使用大端序**

---

## 1. 流转节点注册功能

### 需求：
- 商家与个人都被允许注册流转节点账号，并且不限制数量
- 可以随意注册流转节点账号可能会导致后续【消费意愿指数】计算时算力消耗增加，所以采用工作量证明(Proof of Work)的方式来提高账号注册难度
- 流转节点注册要先于对中心公钥授权，以便于在中心公钥更换时可以重新授权，使得流转节点拥有连续性，不会据丢失原交易数据关联性。所以流转节点注册信息也不需要包含中心公钥信息与中心公钥签名

### 接口协议1-流转节点注册信息（共123字节）：
> 【信息类型2字节(0)】  
> +【uuid16字节】  
> +【注册难度目标4字节】  
> +【随机数4字节】  
> +【流转节点公钥33字节】  
> +【流转节点对信息(前5项数据)签名64字节】  
> ```
> 验证项：
> 1.信息类型为0
> 2.id唯一验证
> 3.注册难度目标与前区块中的注册难度目标一致
> 4.相同的流转节点公钥只能注册一次
> 5.签名为low-s
> 6.前5项数据dblsha256hash值小于注册难度目标
> 7.验证签名
> ```

---

## 2. 中心公钥公证功能

### 需求：
- 为了确保中心公钥的合法性和安全性，防止中心公钥被滥用或伪造，中心公钥需获得流转节点【授权】后才能对其发送的各项信息进行签名

### 接口协议2-中心公钥公证信息（共220字节）：
> 【信息类型2字节(1)】  
> +【uuid16字节】  
> +【流转节点公钥33字节】  
> +【中心公钥33字节】  
> +【流转节点对信息(前4项数据)签名64字节】  
> +【时间戳8字节】  
> +【中心对前述所有信息验证后签名64字节】
> ```
> 验证项：
> 1.信息类型为1 
> 2.id唯一验证 
> 3.流转节点公钥已注册 
> 4.流转节点公钥未授权 
> 5.中心公钥未冻结
> 6.中心公钥是否填写正确 
> 7.签名为low-s 
> 8.验证签名
> ```

---

## 3. 中心公钥冻结功能

### 需求：
- 中心拥有对多项信息进行签名确认的权力，一旦中心私钥泄露将有可能导致系统的完全失效与崩溃，所以需要使用某种方式预防风险：即一旦中心密钥泄露，中心需要能够冻结自身秘钥使其失效
- 冻结不可逆，只能让所有流转节点重新进行【授权】签名，授权新的中心公钥
- 冻结信息只会被签署一次，冻结信息一旦确认会使用原中心秘钥将所有当前未被装块的信息进行装块固定，一旦装块结束，程序将直接终止

### 接口协议3-中心公钥冻结信息（共187字节）：
> 【信息类型2字节(2)】  
> +【uuid16字节】  
> +【中心公钥33字节】  
> +【中心对信息(前3项数据)签名64字节】  
> +【时间戳8字节】  
> +【中心对前述所有信息验证后签名64字节】  
> ```
> 验证项：
> 1.信息类型为2
> 2.id唯一验证
> 3.中心公钥未冻结
> 4.中心公钥是否正确
> 5.签名为low-s
> 6.验证签名
> ```

---

## 4. 流转节点冻结功能

### 需求：
- 流转节点也会存在秘钥泄露风险，所以也需要提供账号冻结功能
- 冻结信息只能发送一次，之后该流转节点账号将无法签名交易信息，这会导致该流转节点的回流率永久性地无法改变，所以需要建议各商家实体注册多个流转节点账号使用，并经常更换账号

### 接口协议4-流转节点冻结信息（共220字节）：
> 【信息类型2字节(3)】  
> +【uuid16字节】  
> +【流转节点公钥33字节】  
> +【中心公钥33字节】  
> +【流转节点对信息(前4项数据)签名64字节】  
> +【时间戳8字节】  
> +【中心账号对前述所有信息验证后签名64字节】  
> ```
> 验证项：
> 1.信息类型为3
> 2.id唯一验证
> 3.流转节点公钥已注册 
> 4.流转节点公钥已授权现公钥 
> 5.流转节点公钥未冻结
> 6.中心公钥未冻结
> 7.中心公钥是否正确
> 8.签名为low-s
> 9.验证签名
> ```

---

## 5. 交易记录功能

### 需求：
- 消费节点向流转节点生成交易记录信息
- 消费节点无需注册，可随时生成
- 在不对流转节点进行限制的情况下，个人或商家是可以使用多个流转节点实现交易流合并与拆分的，所以系统不提供额外的交易分拆功能
- 交易记录信息中金额单位为对应的货币类型最小面值单位，目前暂定0为1微克黄金(2F0580)，1为1分人民币(后续以加入系统的国家的先后顺序决定货币排序)
- 需要设置交易难度目标避免无限制交易攻击

### 接口协议5-交易记录信息（共335字节）：
> 【信息类型2字节(4)】
> +【uuid16字节】
> +【金额8字节】
> +【货币类型2字节】
> +【交易难度目标4字节】
> +【随机数4字节】
> +【消费节点公钥33字节】
> +【流转节点公钥33字节】
> +【中心公钥33字节】
> +【消费节点对信息(前9项数据)签名64字节】
> +【流转节点对信息(*也是前9项数据，方便两者同时签名)签名64字节】
> +【时间戳8字节】
> +【中心账号对前述所有信息验证后签名64字节】
> ```
> 验证项：
> 1.信息类型为4
> 2.id唯一验证
> 3.货币类型在枚举之中
> 4.交易难度目标与前区块中的交易难度目标一致
> 5.流转节点公钥已注册 
> 6.流转节点公钥已授权现公钥 
> 7.流转节点公钥未冻结
> 8.中心公钥未冻结
> 9.中心公钥是否正确
> 10.两个签名都为low-s
> 11.前9项数据dblsha256hash值小于交易难度目标
> 12.验证两个签名
> ```

---

## 6. 交易挂载功能

### 需求：
- 消费节点可以将自己的某笔交易挂载到某流转节点上
- 需要设置交易难度目标避免无限制交易攻击

### 接口协议6-交易挂载信息（共341字节）：
> 【信息类型2字节(5)】  
> +【uuid16字节】  
> +【挂载的交易记录信息的uuid16字节】  
> +【交易难度目标4字节】  
> +【随机数4字节】  
> +【挂载的交易信息的消费节点公钥33字节】  
> +【挂载的流转节点公钥33字节】  
> +【中心公钥33字节】  
> +【消费节点对信息(前8项数据)签名64字节】  
> +【挂载的流转节点对信息(*也是前8项数据，方便两者同时签名)签名64字节】  
> +【时间戳8字节】  
> +【中心账号对前述所有信息验证后签名64字节】  
> ```
> 验证项：
> 1.信息类型为5
> 2.id唯一验证
> 3.挂载的交易记录信息存在
> 4.交易难度目标与前区块中的交易难度目标一致
> 5.消费节点公钥与要挂载的交易信息中的消费节点公钥需相同
> 6.流转节点公钥已注册
> 7.流转节点公钥已授权现公钥
> 8.流转节点公钥未冻结
> 9.中心公钥未冻结
> 10.中心公钥是否正确
> 11.两个签名都为low-s
> 12.前8项数据dblsha256hash值小于交易难度目标
> 13.验证两个签名
> ```

---

## 7. 区块固定功能

### 需求：
- 中心对所有信息进行区块固定，用于防篡改与数据分发
- 参考比特币区块结构设计
- dat文件储存时【魔数4字节(0x6A466D85)】+【后续区块数据字节数8字节】
- 每10分钟固定一次区块
- 注册难度目标、交易难度目标只能通过修改代码改版发布的方式修改

### 接口协议7-区块固定信息（不定字节数）：
> 【版本号4字节(0x1)】  
> +【区块高度8字节】  
> +【相应版本全代码压缩包sha256hash摘要32字节】  
> +【前区块头摘要32字节】  
> +【所有信息默克尔根32字节】  
> +【信息内最大时间戳8字节】  
> +【流转节点注册难度目标4字节】  
> +【消费节点交易难度目标4字节】  
> +【中心公钥33字节】  
> +【固定区块时间戳8字节】  
> +【中心公钥对前述所有信息签名64字节】  
> +【流转节点注册信息数量8字节】+【流转节点注册信息123字节】\* n  
> +【中心公钥公证信息数量8字节】+【中心公钥公证信息220字节】\* n  
> +【中心公钥冻结信息数量8字节】+【中心公钥冻结信息187字节】\* n  
> +【流转节点冻结信息数量8字节】+【流转节点冻结信息220字节】\* n  
> +【交易记录信息数量8字节】+【交易记录信息335字节】\* n  
> +【交易挂载信息数量8字节】+【交易挂载信息341字节】\* n

---

## 8. 消费意愿数值化功能

### 需求：
- 从数据中评估流转节点消费意愿/流转效率

### 评估方案： 

> 回流率：
> > 在消费节点挂载交易后，商家之间会形成一系列的成环或未成环的有向消费链条，可以这样计算A商家对B商家消费的消费回流率：先筛选出所有包含大A商家指向大B商家消费的消费链条，再计算出其中所有成环消费链的金额总和与全部消费链的金额总和的比值  
> ---
> 区间回流率：
> >计算某个时间区间内的回流率，如某商家在一周内，一个月内，一年内的回流率，可以解决随交易量增长回流率逐渐难以下降的问题  
> ---
> 滞留指数：
> > 如果回流率表征相对比率，则滞留指数表征绝对值，在消费节点挂载交易后，商家之间会形成一系列的成环或未成环的有向消费链条，可以这样计算A商家对B商家消费的消费滞留指数：先筛选出所有包含大A商家指向大B商家消费的消费链条，再计算出其中所有未成环消费链的金额总和  
> ---
> 区间滞留指数：
> > 计算某个时间区间内的滞留指数，如某商家在一周内，一个月内，一年内的滞留指数  
> ---
> 总滞留指数（暂定，参考性有限）：
> > 所有商家向某个商家消费的总计滞留指数，可以评估某商家的总滞留程度

                




